[TOC]
***

### 一、简介
* 重绘（Repaint）是当节点需要更改外观而不会影响布局，如修改outline, visibility, color、background-color等。
* 回流（Reflow）用于重新计算文档中各元素的位置和几何形状，以便重新呈现该文档的部分内容或全部内容，叫做重排。
比如调整浏览器窗口的大小、使用涉及计算出的样式的 JavaScript 方法、在 DOM 中添加或移除元素，以及更改某个元素的类，等等

而DOM树与渲染树是紧密相连的，DOM树构建完，渲染树也会随之对页面进行再次渲染，故重排必定会发生重绘，重绘不一定会引发重排。
回流所需要的成本比重绘高的多，改变深层次的节点很可能导致父节点的一系列回流。

所以以下几个动作可能会导致性能问题：
* 改变window大小
* 改变字体
* 添加或删除样式
* 文字改变
* 定位或者浮动
* 盒模型

> 很多人不知道，重绘和回流其实和Event loop有关。
1.当Event loop执行完Microtasks后，会判断document是否需要更新。因为浏览器是60HZ的刷新频率，每16ms才会刷新一次
2.然后判断是否有 resize 或者 scroll，有的话会去触发事件，所以 resize 和 scroll 事件也是至少16ms才会触发一次，并且自带节流功能。
3.判断是否触发了media query
4.更新动画并且发送事件
5.判断是否有全屏操作
6.执行requestAnimationFrame回调
7.执行IntersectionObserver回调，该方法用于判断元素是否可见，可以用于懒加载上，但是兼容性不好。
8.更新界面
9.以上就是一帧中可能会做的事情。如果在一帧中有空闲的时间，就回会去执行requestIdleCallback回调。


### 二、减少重绘和回流

**CSS：**
1. 使用 transform 替代 top

2. 使用 visibility 替换 display: none ，因为前者只会引起重绘，后者会引发回流（改变了布局

3. 避免使用table布局，可能很小的一个小改动会造成整个 table 的重新布局。

4. 尽可能在DOM树的最末端改变class，重排是不可避免的，但可以减少其影响。尽可能在DOM树的最末端改变class，可以限制了回流的范围，使其影响尽可能少的节点。

5. 避免设置多层内联样式，CSS 选择符从右往左匹配查找，避免节点层级过多。

6. 将动画效果应用到position属性为absolute或fixed的元素上，避免影响其他元素的布局，这样只是一个重绘，而不是回流，同时，控制动画速度可以选择 requestAnimationFrame。

7. 避免使用CSS表达式，可能会引发重排。

8. 将频繁重绘或者回流的节点设置为图层，图层能够阻止该节点的渲染行为影响别的节点，例如will-change、video、iframe等标签，浏览器会自动将该节点变为图层。

9. CSS3 硬件加速（GPU加速），使用css3硬件加速，可以让transform、opacity、filters这些动画不会引起回流重绘 。但是对于动画的其它属性，比如background-color这些，还是会引起回流重绘的，不过它还是可以提升这些动画的性能。

> GRU: (Graphics Processing Unit) 图形处理单元，又称图形处理器，是我们所周知的显卡的核心部件，是显卡的“心脏”。
