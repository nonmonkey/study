[TOC]
***

### 一、HTTP协议、HTTPS握手过程中，客户端如何验证证书的合法性

**首先什么是HTTP协议**
超文本传输协议（HyperText Transfer Protocol），位于tcp/ip四层模型(数据链路层、网络层、传输层、应用层)的应用层；通过请求、响应的方式在客户端和服务器之间进行通信；但是缺少安全性，http协议信息传输是通过明文的方式传输，不做任何加密，相当于在网络上裸奔；容易被中间人恶意篡改，这种行为叫做中间人攻击。

缺点：
1.通信使用明文可能会被窃听。
2.不验证通信方的身份可能遭遇伪装。
3.无法证明报文的完整性，可能已遭篡改。

**加密通信**
为了安全性，双方可以使用对称加密的方式key进行信息交流，但是这种方式对称加密秘钥也会被拦截，也不够安全，进而还是存在被中间人攻击的危险。

于是人们又想出来另外一种方式，使用非对称加密的方式；使用公钥/私钥加解密；通信方A发起通信并携带自己的公钥，接收方B通过公钥来加密对称秘钥；然后发送给A；A通过秘钥解密；双发接下来通过对称秘钥来进行加密通信。

但是这种方式还是存在一定安全性问题，中间人虽然不知道发起方A的私钥，但是可以偷天换日，讲拦截发起方的公钥key；并将自己生成的一对公、私钥的公钥发送给B;接收方B并不知道公钥已经被换过了；按照之前的流程，B通过公钥加密自己生成的对称加密秘钥key2发送给A；

这种通信再次被中间人拦截，尽管后面的通信，两者还是用key2通信，但是中间人已经掌握了key2；可以进行轻松的加解密；还是存在被中间人攻击风险。

**解决困境：权威的证书颁发机构CA来解决**
1.制作证书：作为服务端的A，首先把自己的公钥key1发给证书颁发机构，向证书颁发机构进行申请证书；证书颁发机构有一套自己的公私钥，CA通过自己的私钥来加密key1，并且通过服务端网址信息生成一个证书签名，证书签名同样使用机构的私钥进行加密；制作完后，机构将证书发给A。
2.校验证书真伪：当B向服务端A发起通信请求时，A不再直接返回自己的公钥，而是返回一个证书。

> 各大浏览器和操作系统已经维护了所有的权威证书机构的名称和公钥。B只要知道是哪个权威机构发的证书，使用对应的机构公钥，就可以解密出证书签名；接下来，B使用同样的规则，生成自己的证书签名，如果两个签名是一致的，说明证书是有效的。
签名验证成功之后，B就可以再次利用机构的公钥，解密出A的公钥key1，接下来的操作，就是和之前一样的流程了。

**中间人是否会拦截发送假证书到B？**
因为证书的签名是由服务器端网址等信息生成的，并且通过第三方机构的私钥加密中间人无法篡改；所以最关键的是证书的真伪。

**https主要的思想是在http基础上增加了ssl安全层，即以上认证过程**

### 二、https概述

HTTPS就是在安全的传输层上发送http。https没有将未加密的http报文发送给tcp，并通过世界范围内的因特网进行传输，它在将http报文发送给tcp之前，先将其发送给了一个安全层，对其进行加密。http安全层是通过ssl及其现代替代协议TSL来实现的。

优点：
* 使用HTTPS协议可认证用户和服务器，确保数据发送到正确的客户机和服务器
* HTTPS协议是由SSL + HTTP协议构建的可进行加密传输、身份认证的网络协议，要比http协议安全，可防止数据在传输过程中不被窃取、改变，确保数据的完整性。
* HTTPS是现行构架下最安全的解决方案，虽然不是绝对安全，但它大幅增加了中间人攻击的成本。总之https就是身披ssl外壳的http。主要解决了http安全性较低的问题，也使网络攻击者的成本变高。

缺点：
因为加了层ssl，所以在效率方面比较低，会使页面加载的时长延长50%，也会增加10-20%的耗电。需要安装证书，在一定基础上增加部署费用，并且报文加密解密对数据传递有一点的效率影响。

### 三、http和https的区别

http协议的数据都是未加密的，也就是明文，网景公司设置了ssl协议来对http协议传输的数据进行加密处理，简单来说https协议是由http和ssl协议构建的可进行加密传输和身份认证的网络协议，比http协议的安全性更高。主要区别如下：

* HTTPS协议需要ca证书，费用较高
* http超文本传输协议，信息是明文传输，https则是具有安全性的ssl加密传输协议。
* 使用不同的链接方式，端口不同，一般而言，http协议端口为80，https的端口为443。
* http的连接很简单，是无状态的；https协议是由SSL + HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议更安全。


### 四、HTTPS中间人攻击

过程：
1. 服务器向客户端发送公钥
2. 攻击者截获公钥，保留在自己手上
3. 攻击者生成一个伪造的公钥，发给客户端
4. 客户端收到伪造的公钥后，生成加密hash值发给服务器
5. 攻击者获得加密hash值，用自己的私钥解密获得真秘钥
6. 同时生成假的加密hash值，发送给服务器
7. 服务器用私钥解密获取假秘钥
8. 服务器用秘钥加密传输信息

防范方法：
1. 服务器端在发送浏览器的公钥中加入CA证书，浏览器可以验证CA证书的有效性

### 五、http2.0

http/2.0的目标是改善用户使用web时的速度体验

1. http/2.0与http/1.x区别
1）HTTP/2采用二进制格式而非文本格式
2）HTTP/2是完全多路复用，而非有序并阻塞的--只需要一个连接即可实现并行
3）使用报头压缩，HTTP/2降低了开销
4）HTTP/2让服务器可以将相应主动推送到客户端缓存中

2. HTTP/2为什么是二进制？
比起http/1.x这样的文本协议，二进制协议解析起来更高效、’线上‘更紧凑，更重要的是错误少。

3. 为什么HTTP/2需要多路传输？
HTTP/1.x 有个问题叫线端阻塞(head-of-line blocking), 它是指一个连接(connection)一次只提交一个请求的效率比较高, 多了就会变慢。 HTTP/1.1 试过用流水线(pipelining)来解决这个问题, 但是效果并不理想(数据量较大或者速度较慢的响应, 会阻碍排在他后面的请求). 此外, 由于网络媒介(intermediary )和服务器不能很好的支持流水线, 导致部署起来困难重重。而多路传输(Multiplexing)能很好的解决这些问题, 因为它能同时处理多个消息的请求和响应; 甚至可以在传输过程中将一个消息跟另外一个掺杂在一起。所以客户端只需要一个连接就能加载一个页面。

4. 消息头为什么需要压缩？
假定一个页面有80个资源需要加载（这个数量对于今天的web而言还是比较保守的），二每次请求都有1400字节的消息头（这同样也并不少见，因为Cookie和引用等东西的存在），至少要7、8个来回去”在线“获得这些消息头。这还不包括响应时间---那只是从客户端那里获取到他们所花的时间而已。这全都由于TCP的慢启动机制，他会基于对已知有多少个包，来确定还要来回去获取那些包-这很明显的限制了最初的几个来回可以发送的数据包的数量。相比之下，即使是头部轻微的压缩也可以是让那些请求只需要一个来回就能搞定---有时候甚至一个包就可以了。这种开销是可以被节省下来的，特别是当你考虑移动端应用的时候，即使是良好条件下、一般也会看到几百毫秒的来回延迟。

5. 服务器推送的好处是什么？
当浏览器请求一个网页时，服务器将会发送回HTML，在服务器开始发送javascript、图片和CSS前，服务器需要等待服务器解析HTML和发送所有内嵌资源的请求。服务器推送服务通过”推送“那些他认为客户端将会需要的内容到客户端的缓存中，以此来避免往返的延迟。

